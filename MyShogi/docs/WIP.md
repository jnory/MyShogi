
# 『将棋神やねうら王』(2018年8月31日発売) アップデートなどの作業進捗 (Work In Progress)


- このファイルは、既知の問題や作業中の内容を明示することにより、それらに対するバグ報告を未然に防ぐためのものです。

- 全般的な操作説明については[オンラインマニュアル](online_manual.md)をご覧ください。
- アップデート関連の情報、サウンドが再生されない、CPU負荷が高すぎる/低すぎるなどについては、[よくある質問](faq.md)をご覧ください。
- デバッグ機能の使い方などは、[開発者向け機能](dev_manual.md)をご覧ください。
- バグ、要望等は、こちらの記事にどうぞ。→ [『将棋神やねうら王』Update2までの遊戯施設 / やねうら王ブログ](http://yaneuraou.yaneu.com/2018/09/06/%E3%80%8E%E5%B0%86%E6%A3%8B%E7%A5%9E%E3%82%84%E3%81%AD%E3%81%86%E3%82%89%E7%8E%8B%E3%80%8Fupdate2%E3%81%BE%E3%81%A7%E3%81%AE%E9%81%8A%E6%88%AF%E6%96%BD%E8%A8%AD/)


# Update2は(2018年10月上旬ごろリリース予定)


- Update3以降で対応予定のものから、ここで出来そうなものに関して作業中。


# Update3(2018年10月下旬ごろリリース予定)に向けて作業中です(ここに書かれているすべての機能追加をお約束するものではありません)


- 対局設定
  - 時間計測「秒未満切り捨て、最低1秒」「秒未満切り捨て、最低0秒」「秒未満も記録」
  - ストップウォッチ方式の計測も出来るように。(これはUpdate4以降かも)

- 全体設定
  - もっと使いやすい、わかりやすい表示設定・音声設定ダイアログを用意する
  - 各ダイアログのフォント変更機能(フォントサイズも)

- 駒得のみの評価関数「駒得大好きくん 2018」の思考エンジン追加。

- 検討ウインドウ
  - 詰手順の出力機能
  - ミニ盤面のフロート

- 棋譜ウインドウ
  - 棋譜ウインドウのメッセージング処理変更
  - メインウインドウに埋め込み時に畳の左端に表示するモードを追加(kumaさん)
  - 総消費時間の表示
  - 棋譜コメントの表示、編集等
  - 思考エンジンの読み筋を棋譜コメントに記録する

- 成り/不成の選択、後手側だと180度回転させてあって欲しい。(ぐららるさん)

- 形勢グラフ(作業中)
	- このウィンドウ邪魔なので、フロート機能・検討ウインドウに埋める機能などを持たせる予定。
  - ToolStripの◀▶で局面を移動させた時にその局面での形勢表示にならない。
    - 検討ウィンドウのほうと合わせ、通知のハンドラちゃんと書く。
  - 着手や終局の直後に入れ違いで前の局面の思考が送られてきた時に、次の局面の評価値として記録してしまう。
    - あとで修正する。
  - このソフトで保存した棋譜を再度読み込んだ時にその評価値が形勢グラフに反映されない。
  - 駒落ちの時、詰まされると落ちる。(tkponさん)
    - 形勢グラフの範囲外にプロットしている模様。

- ファイルヒストリー(MRUF)
  - ファイルヒストリー、閉じる前に開いていた局面を開いて欲しい。(まふさん)


# Update4以降で対応を検討中


- 棋譜解析
  - 期待勝率に基づく悪手判定
  - MultiPV / 詰め探索などを併用した悪手度の判定
  - 棋力を設定して、その棋力にそぐわない指し手の検出機能

- 描画の高速化
	- 画面描画の時の更新矩形を最適化する
		- 残り時間の描画など

- USIプロトコル対応エンジンを任意に追加する機能
  - エンジンの個別設定をコピーする機能(同エンジン対局がしやすくなる) (odagakiさん)

- ponder(「相手の手番で先読み」)
  - この実装、わりとややこしくて、激指ユーザーとかがターゲットなので必須機能とも言えないので後回し。

- 対局
  - 対局中断→再開が欲しい。
  - 棋譜の途中から対局をするとき、そこより手数を戻そうとすると持ち時間がゼロになるので時間切れ負けになる件
  - 対局終了時に、消していた開始局面以降の分岐を復元する。激指はそうなっている。(T.Kさん)

- 棋譜ウインドウ
  - 棋譜分岐、分岐の指し手、一覧が表示されて欲しい気が。
    - もう少しいいインターフェースを考え中。
  - 棋譜のマージ
  - 棋譜の記法で駒打ちのときには必ず「打」を記すオプション
    - 棋譜表記は、以下のサイトを参考に忠実に守っているのだが、「打」の文字が無いのはわかりにくいと不評。
    - 日本将棋連盟 「棋譜の表記方法」: https://www.shogi.or.jp/faq/kihuhyouki.html
  - 棋譜の自動再生機能

- Mac/Linuxで簡単にビルド出来るように。


# 改修履歴


- "1.2.3"→"1.2.4" [2018/10/05]-[2018/10/XX]
  - 棋譜コントロールがアクティブなときにCtrl+K/Rなどのショートカットキーが効かないのを修正。
  - 棋譜ウインドウ、検討ウインドウ、ショートカットキーで非表示に出来るように。(kumaさん)
    - 表示～再表示がCtrl+K(棋譜ウインドウ)、Ctrl+R(検討ウインドウ)で出来るようになった。
    - 棋譜ウインドウ、検討ウインドウ、最初、非アクティブでpop upさせるように。
  - S七段・S九段、棋力調整
  - Sのつく段位プリセットの説明文の脱字修正。


- "1.2.2"→"1.2.3" [2018/09/27]-[2018/10/04]
  - 定跡を使わない場合にも"no_book"というファイルをエンジン側が読みに行っていたのを修正。
  - Aperyの定跡ファイル(book.bin)はBookDirオプションを無視して、"book/book.bin"を読みに行っている。(ohtaroさんの報告) (修正内容の指摘、tttakさん)
  - デバッグウインドウを出したときに、Filterのテキストボックスにfocusを移動させる。
  - 検討ウインドウ、連続対局のときなど更新が間に合わなくて待たされることがあるの改良。
  - 対局結果の自動保存の設定になっていないとき、連続対局の勝敗のカウントがされないのを修正。
  - 低い段位同士の連続対局だとメニューの更新が1局ずつあるので、デバッグウインドウが出せない
    - Ctrl + D をデバッグウインドウのショートカットにする。
  - メモリ上のLogをデフォルトで1万行までの保存とする。
    - これでも10局分ぐらいは保存できるはず。
    - 1局100KB程度(1000行程度)なので1万局で1000万行、1GBぐらいになる。
    - 連続対局中、Hashサイズの変更は出来ないので(Hashの再初期化をしないので)、メモリギリギリの状態からだと1GBはきつすぎる。
          /// ただし、デバッグウインドウを開いている間は、この行数を超えて表示される。
          /// (これはデバッグウインドウ側で保持しているQueueに追加されていくため)
  - 1級～10級を下方修正。新1級 = 従来の2級 , 新2級 = 従来の4級 , 新3級 = 従来の6級 , … , 新10級 = 従来の20級 相当
  - S七段～S11級を追加。序盤は弱いのに終盤だけ強いということのないように、人間らしい弱さを追求しました。
    - S七段・九段以外の調整完了。S七段・九段の調整はまだ時間かかるので次回。
  - エンジン側との入出力、EncodeをUTF8と変更。
  - エンジン終了時にCancelarationTokenを明示的に解放していなかった。リファクタリングして、この処理をなくした。
    - 連続対局数万局とかやるときにhandle不足で落ちる現象が緩和されるかも。
    - masaさんからの連続対局のレポートをもとに修正できました。masaさんに感謝！
  - デバッグウインドウを閉じるタイミングでメッセージが送られてくると破棄されたWindowでInvokeしてることになって例外が出ていたの修正。
  - 時間無制限のときに名前の表示のところが「/五段」のようになる(masaさん)
    - 修正しました。


- "1.2.1"→"1.2.2" [2018/09/25]-[2018/09/27]
  - クリップボードの貼り付けで拒否されて例外が出ることがある(ohtaroさん)
    - 他のソフトでクリップボードにアクセスしていると例外が出るようです。修正しました。
  - 検討ウインドウをメインウインドウに埋め込んでいるときにメインウインドウを最小化するとSpliterの計算で例外で落ちるの修正。
  - 例外が発生したときのスタックトレース、ちゃんと改行するように。
  - 例外の出力形式、全体的に改善。
  - 開始のときにメモリ不足の警告が出たあと、放置しているとエンジンがタイムアウトになるのを修正。
    - タイムアウトを30秒から15秒に変更。これ以上かかるのは異常である。エンジン側を改修すべき。
    - タイムアウトになったときにエンジン初期化中の画面から進まないの修正。
    - 開始のときのメモリ不足の警告を出すタイミングですでにエンジンが起動していた。
      - 警告を出してからエンジンを起動するように修正。
  - 検討ウインドウの再表示のショートカット、Ctrl+Eが盤面編集とかぶってて利かなかったのでCtrl+Rに変更。
  - メインウインドウ、閉じるときに、棋譜が残っていて、棋譜ウインドウと検討ウインドウがフロート状態だと
    ダイアログが出る瞬間にはそれらが非表示になるのを修正。
  - 検討モードを終了させずに通常対局をすると思考エンジンが空になる。(T.Kさん)
    - 詰検討モードからでも同様だったのでまとめて修正しました。
  - フォントの変更を可能にするための仕組みを導入。
  - Mac + monoで動くようにソースコードから環境依存部分を分離する。
  - 振り駒のアニメーションを行うハンドラ、UI Threadで実行していなかったのを修正。(Mizarさん)
    - 振り駒のときに例外が出ることがあった模様。


- "1.2.0"→"1.2.1" [2018/09/19]-[2018/09/24]
  - メニューのファイルに「ファイルヒストリーの削除」を追加。
  - メニューの棋譜編集をファイルに移動させた。
  - やねうら王側、engine_options.txtの読み込みにバグがあったので全バイナリ修正＆差し替え。
    - SSE2用とか動かなかったのこれが原因の可能性が。
  - やねうら王(エンジン側)にSkillLevel実装
    - 各実行ファイルをbuildしなおし。
  - エンジン接続時にDebugLogにfile pathを出力するように。
  - 例外が出て終了するときにも棋譜を保存するか確認のダイアログが表示されていたの修正。
  - 10段～12段のプリセットでAutoThreadを強制していたのやめる。
  - 連続対局で低い段位同士をやらせるとウインドウメッセージの処理機会が与えられず、
    ウインドウの操作が出来なくなってしまうの何とかする。
    - バッファリングしたことでだいぶ改善された(気がする)
  - 検討ウインドウのDockなどを可能にする。
    - メニューの「ウインドウ」→「検討ウインドウ」に、DockとFollowと埋め込みの機能を追加。
    - 棋譜ウインドウと同じくフロート機能追加する
    - 連続対局のときに検討ウインドウ、閉じても次の局でまた勝手に出てくるの修正。
    - メインウインドウ埋め込み時の縦幅をメニューのウインドウから変更できるように。
  - 棋譜を読み込んだ時に対局者名に反映されない。(msomaさん)
    - 名前の表示方式を変更したときにエンバグしてました。修正しました。
  - 連続対局で低い段位同士をやらせるとウインドウメッセージの処理機会が与えられず、ウインドウの操作が出来なくなってしまったり、
    GDI resourceが枯渇したりするのを改善。
  - 対局者名の下に段位、駒落ちなどの情報があったほうが良いような。
    - 余白がない。持ち時間設定のところに段位と駒落ち情報書いておく。
  - 連続対局のときに平手以外なら手合割を上手のほうに書いておく。
  - 振り駒の画像が表示されないことがある。
    - エンジン初期化直後だし初回読み込みのとき0.5秒で画面素材の読み込みが間に合わないことがあるのか…。
    - 振り駒での対局が確定した時点で先読みしておく。


- "1.1.9"→"1.2.0" [2018/09/16]-[2018/09/19]
  - 手番マーク、対局者名の色で表現したほうが良いのでは
    - 手番側を赤文字で表現するオプションを追加。(色は原色の赤だとどぎついので盤面に合わせてBrushes.IndianRedに)
    - メニューの 表示→「手番側の表現」、「対局者名の横の手番マーク」は削除。
  - 連続対局のとき後手のHash使用率の表示がおかしいのでは。(masaさん)
    - その部分の表示のクリアをしてなくて、初段ぐらいに設定しているとhash使用率がエンジン側から送られてこないので
    それでずっと前の表示が残っていたのでおかしく見えていました。新局面ごとにクリアするようにしました。
  - 棋譜ウインドウのスクロール位置を常に3手先ぐらいまで表示されているように。(T.Kさん)
    - デフォルトでmargin(先が見えている手数) = 3手としました。
    - また棋譜ウインドウの縦幅を狭めているときは、margin = (表示されている項目数-1)/2。
  - マウスホイールによる棋譜のスクロール(Tatuyaさん)
    - 検討モードでメインウインドウにfocusがあるときにマウスホイールの回転で棋譜の指し手を移動できるようにした。(ShogiGUIに倣った)
    - 検討ウインドウにfocusがあるときはうまく動かない。検討ウインドウのフロート化を実装したあとで考える。
  - 振り駒の乱数、.NETの乱数ではなく、もう少しマシな乱数に変更。
  - 思考エンジンのプリセットに11級～20級を追加。
  - 検討ウインドウの継ぎ盤の下のToolStripのほうも非アクティブからだと反応しない問題があったのを修正。


- "1.1.8"→"1.1.9" [2018/09/15]-[2018/09/16]
  - 対局設定画面の「先手」と「後手」の文字、駒落ちだと上手と下手にすべきだし、振り駒で手番が入れ替わったときも
    ややこしいし、よくない。「あなた」と「わたし」を人間時のデフォルトに変更する。
  - 連続対局終了時の名前の表示を元に戻さないように修正。
  - ShogiGUIにあるような振り駒機能が欲しい。(math26さん)
    - 実装しました。
    - image/game_effect/piece_toss_v1.png 追加
    - 振り駒で表が3枚以上出来た時には、対局設定ダイアログの左側のプレイヤーが先手(開始局面の手番側)に。
    - 人間 vs 人間のときは、対局設定ダイアログの左側のプレイヤーが後手(開始局面の非手番側)になった場合、自動的に盤面反転。
      - これはタブレット端末で二人で対局するときにこうなっていないと不便。
  - ToolStripのボタン、非アクティブ状態からだと2回クリックしないと反応しない。(T.Kさん)
    - 修正しました。MenuStripも同様であったので、こちらも同様に修正しました。
  - 駒をクリックして1手戻るボタンをクリックしたときに駒を掴んだままになる(kumaさん)
    - 修正しました。


- "1.1.7"→"1.1.8" [2018/09/12]-[2018/09/15]
  - 秒読み60秒のとき「40秒・・・50秒・1・2・3・・」みたいな感じで秒読み音声を入れる。
  - 秒読み30秒のとき「10秒・・・20秒・1・2・3・・」みたいな感じで秒読み音声を入れる。
    - メニューの音声のところに設定追加。
  - 対局者名、段位、手合、中断なども棋譜ファイル名に書き出す。
    - 連続対局のとき、および、ファイルに名前をつけて保存するときのデフォルトに反映。
  - tanuki-詰将棋エンジン、少し改造。以前解けなかった問題が解けることがあるかも。
  - 例外が出たときのエラーダイアログ、コピペが出来るように特別なダイアログを用意した。
  - 「コンピューターは1手に必ずこれだけ使う」オプション、チェックボックスで無効化できるように。
  - tanuki-詰将棋エンジン
    - 他の不詰の局面を調べた直後に(エンジンをそのまま終了させずに)、詰むはずの局面を解かせたときに即座に不詰が返ってくる問題。
    - 「終」ボタンでいったんエンジンを終了させて再度解かせると正常に解ける模様。調査中。
    - Hash足りないだけのような…。df-pnで200手以上の長手数の詰将棋を解くにはGC(garbage collection)が欲しい気が…。
  - メニューの「表示」のところに「対局エフェクト」の有無の設定を追加。
  - 対局中断～再開時の素材表示追加。
    - 連続対局ではなく、かつ、対局設定の「開始局面」のところが「現在の局面」ならば「対局再開」と表示。
    - 最後の指し手が「対局中断」の指し手であるなら「対局中断」と表示。
    - 対局開始・終了 の素材差し替え
      - image/game_effect/game_start_v1.png
    - 対局中断・再開の素材追加
      - image/game_effect/game_interrupt_v1.png
  - タブレットモードの縦置きで画面が横にはみ出すのを軽減する #56 (Mizarさんのプルリク)
    - タブレットモードの縦置きで画面が横にはみ出すのを軽減する  …
    - 1130x1080 の画面サイズを基準にスケーリングする
  - 検討ウインドウ、rootSfen設定されたときにHash使用率の値などの表示を初期化する
  - 棋譜ウインドウ、丸ごと更新されるときは、差分更新やめる。
    - 棋譜ウインドウ、丸ごと更新されるときの動作が高速化した。
    - DCのleak少し減った気がする。


- "1.1.6"→"1.1.7" [2018/09/10]-[2018/09/11]
  - 本譜のみを書き出す機能
    - 本譜のみを書き出す、でファイルに書き出したあと「上書き保存」はどういう挙動になるのかだとか、わりと混乱を招きそう。
    - 本譜のみを書き出す機能を追加するのではなく、本譜以外の分岐をクリアする機能を追加することにした。
    - メニューに「棋譜編集」という項目を追加
    - 「本譜以外の分岐をクリアする」
  - HASH使用率、50%を超えたところで赤い文字で表示するようにした。
  - KIF : Kifu for Windowsのしおりを使った棋譜を読み込むと例外で落ちるのを修正。
    - KIF/KI2: "&" で始まる行を無視するように #54(Mizarさんのプルリク)
  - tanuki-詰将棋エンジン , 詰探索中の出力を変更した (#91)   (tanuki-さんのやねうら王へのプルリク)
    - clang++によるコンパイル警告を抑制した
    - 詰探索中の進捗状況の出力を変更した
    - Hash使用率が1秒ごとぐらいに更新されるようになった。
  - コンピューター側、指し手が速すぎて追いかけられないので、1手に必ず1秒使うようなモードが欲しい。
    - コンピューターが返したbest moveに対して、x[ms]になるまでGUI側が指し手を無視する機能を用意しました。
    - 対局設定ダイアログの「コンピューターは1手に必ずこれだけ使う」
  - KIF/CSA: 激指定跡道場4への対応 #53(Mizarさんのプルリク)
    - 『激指定跡道場4』で書き出したCSA形式のファイルが読み込めなかったのを修正。
  - Updater、管理者権限で実行されていればUpdaterの再起動をしないコードを追加。


- "1.1.5"→"1.1.6" [2018/09/08]-[2018/09/10]
  - メニューの「表示」→「対局者名の先頭の手番記号」追加。「☗」「☖」か、「▲」「△」を付与できるようにした。
  - 対局結果、駒落ちのときの結果を先手勝ちではなく下手勝ちのようにする。(math26さん)
    - この対応のため、対局結果のcsvに平手か駒落ちかも出力するfieldを追加しました。
    - 以前の棋譜に対しては対局結果画面で見ても修正されません。以降の駒落ち戦のみ修正して記録されます。
  - .KIFなどの棋譜ファイルを拡張子関連付けで本ソフトと関連付けたときにうまく起動するようにした。
    - コマンドラインの第1パラメーターに棋譜ファイル名があるときはそれを開くべき棋譜ファイル名と解釈するようにした。
  - 起動時のworking directoryをMyShogi.exeが存在したフォルダに設定するコード追加。
    - ショートカットから起動するときにworking directoryが異なるとうまく画面素材などを読み込めないのでこのコードを追加した。
  - メインウインドウを最小化したときに検討ウインドウをタスクバー上で非表示に。(kumaさん)
    - 対応しました。最小化から復帰させたときに他のウインドウの背後に行くので、メインウインドウと親子関係を持たせる改造もしたほうがよさげ。
  - 対局終了直後だけ、「◀」ボタンを押しても一手戻らない件。
    - 修正しました。
  - 棋譜ウインドウの表示位置を変更したときに一瞬、変な位置に表示されてから移動していたのを修正。
  - 棋譜を開くときに、棋譜ウインドウがTopMostなのでファイルダイアログより前面に出てくるの改善。
    - Owner設定するようにして、TopMostやめた。


- "1.1.4"→"1.1.5" [2018/09/07]-[2018/09/07]
  - メインウインドウを最小化したときに棋譜ウインドウをウインドウ化しているときには非表示にするように。(kumaさん)
  - 実行ファイルのアプリケーションアイコンを設定。(kumaさん)
  - 棋譜ウインドウ、ウインドウモード時に、文字サイズを変更するボタンを追加。(右下の「+」と「-」)
  - 棋譜ウインドウに「消一手」ボタン追加。
    - 棋譜の末尾を1手消す操作
    - 棋譜ウインドウのボタンにtooltip追加。
  - V1.1.4で対局中に閉じるときなど、警告ダイアログが2回出るようになっていたの修正。
  - tanuki-詰将棋エンジン , 置換表エントリの世代を削除し、置換表エントリのハッシュの最下位ビットに探索開始局面の手番を入れるようにした #89 (tanuki-さん。やねうら王へのプルリク)
    - この修正により、一度解いた局面を解かせるときには一瞬で応答が返ってくるようになった。
  - tanuki-詰将棋エンジン バグ修正。
    詰将棋ルーチンで受け側の局面から探索させたあとに攻め側の局面から探索させると不詰と出力されるバグを修正した #88 (tanuki-さんのやねうら王へのプルリク)


- "1.1.3"→"1.1.4" [2018/09/04]-[2018/09/06]
  - CSA: 一部ツールの出力する棋譜による不具合に対応 #52 (Mizarさんのプルリク)
    - 将棋ウォーズ棋譜管理ツールというフリーソフトで保存したcsa形式のファイルが読み込めない。(てらっちさん)
  - メニューの「ウインドウ」→「棋譜ウインドウ」→「表示位置」でフロート機能などを使えるようになった。
    - フロート状態を次回起動時に復元するようにした。
    - Dock機能追加。メインウインドウに対して上下左右、好きなところにDockさせられるようにする。
  - tanuki-詰将棋エンジン、ハッシュエントリをつぶすとき、探索ノード数を考慮するようにした #87 tanuki-さんのやねうら王へのプルリク
  - 駒をクリックするときにマウスカーソルを微小動かすと駒のドラッグ処理になり、駒を掴んだ直後に駒を離してしまう。(地球市民さん)
    - 確かにあまり嬉しくない挙動なので修正しました。
  - 連続対局のときの勝数、win-lose-draw ではなくwin-draw-loseに変更する。(odagaki0621さん)


## 過去の改修履歴

- ここ以前の改修履歴については、[過去の改修履歴](過去の改修履歴.md)のほうに移動させました。
